## 📦 핵심 도메인

### Waiting (대기)
**책임**: 대기 상태 및 생명주기 관리

**핵심 개념**:
- 사용자가 특정 부스에 대기 등록
- 호출부터 완료까지 상태 전이 관리
- 노쇼, 취소 등 예외 상황 처리

**속성**:
- 식별자 (ID, 사용자, 부스)
- 상태 (호출, 입장, 완료)
- 시간 정보 (등록, 호출, 입장, 완료 시각)
- 완료 유형 (정상, 노쇼, 취소)

**주요 행위**:
- `enter()`: 입장 확인
- `complete()`: 체험 완료
- `markAsNoShow()`: 노쇼 처리
- `cancel()`: 대기 취소

---

### Booth (부스)
**책임**: 부스 운영 상태 관리

**핵심 개념**:
- 부스별 운영 시간 관리
- 수용 인원(정원) 관리
- 운영 상태 (오픈/마감)

**속성**:
- 식별자 (ID, 이름)
- 소속 대학 (University 참조)
- 정원 정보 (최대 인원)
- 운영 정보 (상태, 시간)

**주요 행위**:
- `open()`: 부스 오픈
- `close()`: 부스 마감
- `isOpen()`: 운영 중 여부 확인

---

### User (사용자)
**책임**: 사용자 정보 및 역할 관리

**핵심 개념**:
- 축제 방문자 식별
- 알림 설정 관리
- 역할 구분 (일반 사용자 / 스태프)

**속성**:
- 식별자 (ID, 이메일, 닉네임)
- 알림 설정 (푸시 알림 동의)
- 역할 (VISITOR / STAFF)

---

### University (대학)
**책임**: 축제 주최 대학 관리

**핵심 개념**:
- 대학별 축제 관리
- 부스 소속 구분

**속성**:
- 식별자 (ID, 대학명)
- 도메인 (이메일 도메인, 예: snu.ac.kr)

**관계**:
- University 1 : N Booth

---

---

## 🔄 상태 전이

### Waiting 생명주기
```
[대기 중]
  - 캐시에만 존재
  - 순번 관리
  
    ↓ 호출 (스태프 트리거)
    
[호출됨 CALLED]
  - 영구 저장소에 기록 시작
  - 푸시 알림 발송
  - 노쇼 타이머 시작
  
    ↓ 
    
[입장 ENTERED]           [노쇼 NO_SHOW]
  (스태프 확인)            (타임아웃)
    ↓                      ↓
[완료 COMPLETED]        [완료 COMPLETED]
  (정상 종료)             (노쇼 종료)
```

**상태 전이 규칙**:
- `CALLED → ENTERED`: 스태프 확인 필요
- `CALLED → NO_SHOW`: 타임아웃 시 자동
- `ENTERED → COMPLETED`: 스태프 완료 처리
- `CALLED → CANCELLED`: 사용자 취소 (향후)

---

## 📐 비즈니스 규칙

### 1. 대기 등록 규칙
- **동시 대기 제한**: 1명당 최대 2개 부스
- **중복 방지**: 같은 부스 중복 등록 불가
- **멱등성**: 대기열 존재 여부로 중복 등록 방지 (큐 기반 멱등성)
- **운영 시간**: 부스 운영 중일 때만 등록 가능

### 2. 호출 규칙
- **순서 보장**: 대기열 순서대로 1명씩
- **정원 체크**: 부스에 여유가 있어야 호출 가능
- **스태프 트리거**: 스태프가 "다음 사람 호출" 버튼 클릭

### 3. 입장 규칙
- **상태 검증**: 호출된 상태여야 입장 가능
- **노쇼 처리**: 타임아웃 내 미입장 시 자동 노쇼
- **회전율**: 노쇼 후 즉시 다음 사람 호출 가능

### 4. 완료 규칙
- **상태 검증**: 입장 확인된 상태여야 완료 가능
- **정원 감소**: 완료 시 부스 정원 1 감소
- **통계 반영**: 완료 데이터 집계

---

## 🚨 도메인 예외

### 등록 관련
- `AlreadyRegisteredException`: 이미 등록됨
- `MaxWaitingExceededException`: 최대 대기 수 초과
- `BoothClosedException`: 부스 마감 상태

### 호출 관련
- `BoothFullException`: 부스 정원 초과
- `QueueEmptyException`: 대기열 비어있음

### 상태 관련
- `InvalidStatusException`: 잘못된 상태 전이
- `WaitingNotFoundException`: 대기 정보 없음

---

## 🔍 불변 규칙 (Invariants)

### Waiting
- 호출 시각은 등록 시각보다 이후여야 함
- 입장 시각은 호출 시각보다 이후여야 함
- 완료 시각은 입장 시각보다 이후여야 함
- 호출된 대기는 반드시 완료 유형을 가져야 함

### Booth
- 현재 인원은 최대 정원을 초과할 수 없음
- 현재 인원은 0 이상이어야 함

### User
- 활성 대기는 최대 2개까지만 가능

---

## 💡 Policy (정책 객체)

### MaxWaitingPolicy
**규칙**: 1명당 최대 2개 부스 대기  
**검증 시점**: 대기 등록 시  
**예외**: `MaxWaitingExceededException`

### BoothCapacityPolicy
**규칙**: 정원 여유 있을 때만 호출  
**검증 시점**: 호출 시  
**예외**: `BoothFullException`

**설계 노트**:
- 현재는 대기열 상태 자체가 멱등성 체크 역할을 수행
- 대기 취소 시 큐에서 제거되므로 재등록 가능
- 별도 멱등성 키 저장소(`IdempotencyCachePort`) 인프라는 구현되어 있으나 미사용
- 향후 결제/쿠폰 등 엄격한 멱등성이 필요한 기능 추가 시 활용 가능

### NoShowPolicy
**규칙**: 타임아웃 내 미입장 시 노쇼  
**검증 시점**: 주기적 확인  
**처리**: 자동 노쇼 처리

---

**Last Updated**: 2025-12-15
**Version**: 1.1